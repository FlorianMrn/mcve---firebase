const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    databaseURL: "https://katalys-my-scan-bdd.firebaseio.com"
  });

const firestore = admin.firestore();
// Imports the Google Cloud client library
const {Storage} = require('@google-cloud/storage');

// Creates a client
const storage = new Storage();

async function listFiles() {
  // Lists files in the bucket
  const [files] = await storage.bucket('gs://katalys-my-scan-bdd.appspot.com/').getFiles();

  files.forEach(file => {
      if (file.name.includes('products')) {

        const ean = file.name.split('/')[1].split('_')[0]

        if (!ean.includes(".")) {
            return file.getSignedUrl({
                action: 'read',
                expires: '03-09-2491'})
                .then((signedUrl) => {

                    const snapshot = firestore.collection("products").where('url', '==', signedUrl[0]).get();

                    if (snapshot.empty) {
                        console.log('No matching documents.');
                        return;
                    } 

                    returnsnapshot.forEach(doc => {
                        console.log(doc.id, '=>', doc.data());
                    });
            })
            
        }
        
      }
    
  });
}

listFiles().catch(console.error);